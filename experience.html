<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Recipe Costing</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg: #FDFCFB; --surface: #FFFFFF; --surface-light: #F9F7F4;
            --accent: #5D4037; --accent-dark: #3E2723; --text: #2C2420;
            --text-dim: #8D817A; --success: #455A64; --border: #E0D7D0;
        }
        body { font-family: 'Outfit', sans-serif; background: var(--bg); color: var(--text); padding: 2rem; line-height: 1.5; }
        .container { max-width: 1000px; margin: 0 auto; }
        header { text-align: left; margin-bottom: 2rem; border-bottom: 2px solid var(--accent); padding-bottom: 1rem; }
        .calculator-card { background: var(--surface); border-radius: 12px; padding: 2rem; border: 1px solid var(--border); box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        .section-label { font-size: .75rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: .15em; margin-bottom: 1rem; font-weight: 700; display: block; }
        .recipe-meta { display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; margin-bottom: 2rem; }
        input, textarea { width: 100%; padding: .8rem; background: var(--surface-light); border: 1px solid var(--border); border-radius: 6px; font-family: inherit; font-size: 1rem; }
        textarea { min-height: 150px; font-family: 'Space Mono', monospace; border: 2px dashed var(--border); }
        .btn { background: var(--accent); color: #fff; border: none; padding: 1rem; border-radius: 6px; font-weight: 600; cursor: pointer; transition: 0.2s; width: 100%; }
        .btn:hover { background: var(--accent-dark); transform: translateY(-1px); }
        table { width: 100%; border-collapse: collapse; margin-top: 2rem; font-family: 'Space Mono', monospace; }
        th { background: var(--surface-light); color: var(--accent); font-size: .7rem; padding: 1rem; text-align: left; border-bottom: 2px solid var(--border); }
        td { padding: 1rem; border-bottom: 1px solid var(--border); }
        .calculator-display { background: var(--accent); color: white; border-radius: 8px; padding: 1.5rem; margin-top: 2rem; }
        .display-row { display: flex; justify-content: space-between; margin-bottom: 0.5rem; opacity: 0.9; }
        .total-row { font-size: 1.8rem; font-weight: 700; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 1rem; opacity: 1; }
        .add-row { display: grid; grid-template-columns: 2fr 1fr 1fr 50px; gap: .5rem; margin-top: 1rem; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Recipe Costing Master</h1>
        <p style="color:var(--text-dim)">Synced with: Ingredient_Master</p>
    </header>

    <div class="calculator-card">
        <span class="section-label">1. Recipe Basic Info</span>
        <div class="recipe-meta">
            <input id="recipeName" placeholder="Enter Recipe Name (e.g. French Halwai)">
            <input id="itemsPerBatch" type="number" value="1" min="1" oninput="calculateTotal()" placeholder="Yield / Batch Qty">
        </div>

        <span class="section-label">2. Ingredient Input (Qty Unit Name)</span>
        <textarea id="recipeInput" placeholder="200 g sugar&#10;500 ml milk&#10;100 g butter"></textarea>
        <button class="btn" onclick="extractIngredients()">Analyze Ingredients & Prices</button>

        <table id="ingTable">
            <thead>
                <tr>
                    <th>Ingredient</th><th>Qty</th><th>Unit</th><th>Base(g/ml)</th><th>Price(₹)</th><th>Cost(₹)</th><th></th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>

        <div class="add-row">
            <input id="newIng" placeholder="Manual Add Name">
            <input id="newQty" placeholder="Qty">
            <input id="newPrice" placeholder="Price">
            <button class="btn" style="padding:0" onclick="addManual()">+</button>
        </div>

        <div class="calculator-display">
            <div class="display-row"><span>Total Batch Cost</span><span id="totalCost">₹0.00</span></div>
            <div class="display-row"><span>Total Yield</span><span id="yieldDisplay">1 Item</span></div>
            <div class="display-row total-row"><span>Cost Per Item</span><span id="perItem">₹0.00</span></div>
        </div>

        <button id="saveBtn" class="btn" style="background:#2E7D32; margin-top: 2rem;" onclick="saveToSheet()">Save Final Costing to Sheet</button>
    </div>
</div>

<script>
    const MASTER_URL = "PASTE_YOUR_NEW_DEPLOYED_URL_HERE";
    
    let MASTER = {};
    let ingredients = [];
    const units = { g:1, kg:1000, ml:1, l:1000, tsp:5, tbsp:15, cup:240, unit:1, piece:1 };

    // Load Prices from Sheet
    fetch(MASTER_URL).then(r => r.json()).then(d => { MASTER = d; console.log("Database Ready"); });

    function parseFraction(val) {
        const fracs = { '½': 0.5, '¼': 0.25, '¾': 0.75 };
        if (fracs[val]) return fracs[val];
        if (val.includes('/')) {
            const [num, den] = val.split('/');
            return parseFloat(num) / parseFloat(den);
        }
        return parseFloat(val);
    }

    function extractIngredients() {
        const lines = document.getElementById('recipeInput').value.split('\n');
        ingredients = [];

        lines.forEach((line, index) => {
            if (!line.trim()) return;
            // Best extraction logic: handles decimals, fractions, and units
            const match = line.match(/^([\d.\/½¼¾]+)\s*([a-zA-Z]*)\s*(.+)/);
            
            if (match) {
                const qty = parseFraction(match[1]);
                const unit = match[2].toLowerCase() || 'g';
                const name = match[3].trim();
                const sheetData = MASTER[name.toLowerCase()];

                ingredients.push({
                    id: Date.now() + index,
                    name: name,
                    qty: qty,
                    unit: unit,
                    bQty: sheetData ? sheetData.baseQty : 1000,
                    price: sheetData ? sheetData.price : 0,
                    locked: !!sheetData
                });
            }
        });
        render();
    }

    function calculateTotal() {
        const batch = parseFloat(document.getElementById('itemsPerBatch').value) || 1;
        let total = 0;
        
        ingredients.forEach(i => {
            const mult = units[i.unit.toLowerCase()] || 1;
            const cost = (parseFloat(i.qty) * mult / parseFloat(i.bQty)) * parseFloat(i.price);
            total += cost;
        });

        document.getElementById('totalCost').innerText = `₹${total.toFixed(2)}`;
        document.getElementById('yieldDisplay').innerText = `${batch} Item(s)`;
        document.getElementById('perItem').innerText = `₹${(total / batch).toFixed(2)}`;
    }

    function render() {
        const body = document.getElementById('tableBody');
        body.innerHTML = ingredients.map(i => {
            const mult = units[i.unit.toLowerCase()] || 1;
            const cost = (parseFloat(i.qty) * mult / parseFloat(i.bQty)) * parseFloat(i.price);
            return `<tr>
                <td><b>${i.name}</b></td>
                <td><input value="${i.qty}" onchange="upd(${i.id},'qty',this.value)"></td>
                <td><input value="${i.unit}" onchange="upd(${i.id},'unit',this.value)"></td>
                <td><input value="${i.bQty}" onchange="upd(${i.id},'bQty',this.value)"></td>
                <td><input type="number" value="${i.price}" ${i.locked ? 'style="background:#eee" readonly' : ''} onchange="upd(${i.id},'price',this.value)"></td>
                <td>₹${cost.toFixed(2)}</td>
                <td><button onclick="del(${i.id})" style="border:none;background:none;cursor:pointer;color:red">✕</button></td>
            </tr>`;
        }).join('');
        calculateTotal();
    }

    function upd(id, f, v) { const item = ingredients.find(x => x.id === id); if(item) item[f]=v; render(); }
    function del(id) { ingredients = ingredients.filter(x => x.id !== id); render(); }
    
    function addManual() {
        ingredients.push({ id: Date.now(), name: document.getElementById('newIng').value, qty: document.getElementById('newQty').value || 1, unit: 'unit', bQty: 1, price: document.getElementById('newPrice').value || 0 });
        render();
    }

    async function saveToSheet() {
        const btn = document.getElementById('saveBtn');
        const name = document.getElementById('recipeName').value;
        if (!name) return alert("Please enter Recipe Name");

        btn.innerText = "Processing...";
        btn.disabled = true;

        const summary = ingredients.map(i => `${i.name}: ${i.qty}${i.unit}`).join(" | ");
        const payload = {
            recipeName: name,
            batchSize: document.getElementById('itemsPerBatch').value,
            totalCost: document.getElementById('totalCost').innerText,
            costPerItem: document.getElementById('perItem').innerText,
            ingredientsSummary: summary
        };

        fetch(MASTER_URL, { method: "POST", body: JSON.stringify(payload) })
        .then(() => {
            alert("Saved successfully!");
            btn.innerText = "Save Final Costing to Sheet";
            btn.disabled = false;
        }).catch(() => {
            alert("Error saving. Check Script Permissions.");
            btn.disabled = false;
        });
    }
</script>
</body>
</html>
