<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recipe Cost Calculator</title>

    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg: #FAF8F5; --surface: #FFFFFF; --surface-light: #F5F1EB;
            --accent: #8B7355; --accent-dark: #6B5644; --text: #3E3028;
            --text-dim: #9B8B7E; --success: #7A6F5D; --error: #B8856A; --border: #E8DFD4;
        }
        body { font-family: 'Outfit', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; padding: 2rem; }
        .container { max-width: 1100px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 2.5rem; }
        h1 { font-size: 2.5rem; font-weight: 700; }

        .calculator-card {
            background: var(--surface);
            border-radius: 16px;
            padding: 2.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,.08);
            border: 1px solid var(--border);
        }

        .section-label {
            font-size: .85rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: .1em;
            margin-bottom: .75rem;
            font-weight: 600;
        }

        .recipe-meta {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .recipe-meta input, textarea {
            width: 100%;
            padding: .8rem;
            background: var(--surface-light);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-family: inherit;
        }

        textarea { min-height: 120px; font-family: 'Space Mono', monospace; }

        .btn {
            background: var(--accent);
            color: #fff;
            border: none;
            padding: .9rem 2rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: .75rem;
        }

        .btn:hover { background: var(--accent-dark); }

        .btn-secondary {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
            margin-top: .5rem;
            font-size: .7rem;
        }

        .btn-success { background: #5d7a61; margin-top: 2rem; }

        table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'Space Mono', monospace;
            font-size: .9rem;
        }

        th, td {
            padding: .75rem;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: var(--surface-light);
            font-size: .75rem;
            color: var(--accent);
            text-align: left;
        }

        td input {
            width: 100%;
            padding: .4rem;
            border: 1px solid var(--border);
            border-radius: 4px;
        }

        .calculator-display {
            background: var(--surface-light);
            border-radius: 8px;
            padding: 1.5rem;
            border: 1px solid var(--border);
            margin-top: 2rem;
        }

        .display-row {
            display: flex;
            justify-content: space-between;
            padding: .5rem 0;
        }

        .total-row {
            border-top: 2px solid var(--accent);
            font-size: 1.5rem;
            font-weight: 700;
            padding-top: 1rem;
        }

        .add-row {
            display: flex;
            gap: .5rem;
            margin-top: 1rem;
        }

        .add-row input {
            padding: .6rem;
            border: 1px solid var(--border);
            border-radius: 6px;
        }

        .add-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: 0 1.5rem;
            border-radius: 6px;
            cursor: pointer;
        }
    </style>
</head>

<body>
<div class="container">
<header>
    <h1>Recipe Cost Calculator</h1>
    <p style="color:var(--text-dim)">Auto pricing from Google Sheets</p>
</header>

<div class="calculator-card">

<div class="section-label">Recipe Identity</div>
<div class="recipe-meta">
    <input id="recipeName" placeholder="Recipe name">
    <input id="itemsPerBatch" type="number" value="1" min="1" oninput="calculateTotal()">
</div>

<div class="section-label">Paste Ingredients</div>
<textarea id="recipeInput" placeholder="200 g sugar"></textarea>
<button class="btn" onclick="extractIngredients()">Extract & Analyze</button>

<table style="margin-top:2rem">
<thead>
<tr>
<th>Ingredient</th><th>Qty</th><th>Unit</th><th>Base Qty</th><th>Price ₹</th><th>Cost</th><th></th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>

<div class="add-row">
    <input id="newIng" placeholder="Ingredient">
    <input id="newQty" placeholder="Qty">
    <input id="newPrice" placeholder="Price">
    <button class="add-btn" onclick="addManual()">+</button>
</div>

<div class="calculator-display">
    <div class="display-row"><span>Total Batch Cost</span><span id="totalCost">₹0</span></div>
    <div class="display-row total-row"><span>Cost per Item</span><span id="perItem">₹0</span></div>
</div>

<button class="btn btn-success" onclick="exportToCSV()">Export to CSV</button>
<button class="btn btn-secondary" onclick="location.reload()">Reset</button>

</div>
</div>

<script>
let ingredients = [];
const units = { g:1, kg:1000, ml:1, l:1000, tsp:5, tbsp:15, cup:240, unit:1 };

// UPDATED URL
const MASTER_URL = "https://script.google.com/macros/s/AKfycbwuI-57C7vHJ_dCvJAcUsCKCdrSUtkIXhlJfas_AQfBlMnMfdusayP2M9A_KWRNzcOsRg/exec";
let MASTER = {};

// Improved fetch with error handling to prevent button freeze
fetch(MASTER_URL)
    .then(r => r.json())
    .then(d => {
        MASTER = d;
        console.log("Master Data Loaded:", MASTER);
    })
    .catch(e => console.error("Could not load Google Sheet data:", e));

function calculateCost(q, u, b, p) {
    let qty = parseFloat(q) || 0;
    let base = parseFloat(b) || 1;
    let price = parseFloat(p) || 0;
    let unitMultiplier = units[u.toLowerCase()] || 1;
    
    return (qty * unitMultiplier / base) * price;
}

function extractIngredients() {
    ingredients = [];
    const lines = document.getElementById('recipeInput').value.split('\n');
    
    lines.forEach((l, i) => {
        if (!l.trim()) return;
        
        // Regex to handle: 200 g sugar OR 200g sugar
        const m = l.match(/^([\d.\/½¼¾]+)\s*([a-zA-Z]*)\s+(.+)/);
        
        if (m) {
            const name = m[3].trim();
            const key = name.toLowerCase();
            const master = MASTER[key];

            ingredients.push({
                id: Date.now() + i,
                name: name,
                qty: m[1],
                unit: m[2] || 'unit',
                bQty: master ? master.baseQty : 1,
                price: master ? master.price : 0,
                locked: !!master
            });
        }
    });
    render();
}

function render() {
    const tableBody = document.getElementById('tableBody');
    tableBody.innerHTML = ingredients.map(i => {
        const cost = calculateCost(i.qty, i.unit, i.bQty, i.price);
        return `<tr>
        <td><b>${i.name}</b></td>
        <td><input value="${i.qty}" onchange="upd(${i.id},'qty',this.value)"></td>
        <td><input value="${i.unit}" onchange="upd(${i.id},'unit',this.value)"></td>
        <td><input value="${i.bQty}" onchange="upd(${i.id},'bQty',this.value)"></td>
        <td><input type="number" value="${i.price}" ${i.locked ? 'disabled style="background:#eee"' : ''} 
            onchange="upd(${i.id},'price',this.value)"></td>
        <td>₹${cost.toFixed(2)}</td>
        <td><button onclick="del(${i.id})" style="border:none; background:none; cursor:pointer; color:var(--error); font-weight:bold;">×</button></td>
        </tr>`;
    }).join('');
    calculateTotal();
}

function upd(id, f, v) {
    const item = ingredients.find(x => x.id === id);
    if (item) item[f] = v;
    render();
}

function del(id) {
    ingredients = ingredients.filter(x => x.id !== id);
    render();
}

function addManual() {
    const name = document.getElementById('newIng').value;
    const qty = document.getElementById('newQty').value;
    const price = document.getElementById('newPrice').value;
    
    if (!name) return;

    ingredients.push({
        id: Date.now(),
        name: name,
        qty: qty || 1,
        unit: 'unit',
        bQty: 1,
        price: price || 0,
        locked: false
    });
    
    document.getElementById('newIng').value = '';
    document.getElementById('newQty').value = '';
    document.getElementById('newPrice').value = '';
    render();
}

function calculateTotal() {
    const batchSize = parseFloat(document.getElementById('itemsPerBatch').value) || 1;
    const total = ingredients.reduce((sum, i) => sum + calculateCost(i.qty, i.unit, i.bQty, i.price), 0);
    
    document.getElementById('totalCost').innerText = `₹${total.toFixed(2)}`;
    document.getElementById('perItem').innerText = `₹${(total / batchSize).toFixed(2)}`;
}

function exportToCSV() {
    if (ingredients.length === 0) return alert("No data to export");
    let csv = "Ingredient,Qty,Unit,Cost\n";
    ingredients.forEach(i => {
        csv += `${i.name},${i.qty},${i.unit},${calculateCost(i.qty, i.unit, i.bQty, i.price).toFixed(2)}\n`;
    });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
    a.download = `${document.getElementById('recipeName').value || 'recipe'}_costing.csv`;
    a.click();
}
</script>
</body>
</html>
