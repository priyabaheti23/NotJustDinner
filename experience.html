<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recipe Cost Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg: #FAF8F5; --surface: #FFFFFF; --surface-light: #F5F1EB;
            --accent: #8B7355; --accent-dark: #6B5644; --text: #3E3028;
            --text-dim: #9B8B7E; --success: #7A6F5D; --error: #B8856A; --border: #E8DFD4;
        }
        body { font-family: 'Outfit', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; padding: 2rem; }
        .container { max-width: 1100px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 2.5rem; }
        .calculator-card { background: var(--surface); border-radius: 16px; padding: 2.5rem; box-shadow: 0 1px 3px rgba(0,0,0,.08); border: 1px solid var(--border); }
        .section-label { font-size: .85rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: .1em; margin-bottom: .75rem; font-weight: 600; }
        .recipe-meta { display: grid; grid-template-columns: 2fr 1fr; gap: 1rem; margin-bottom: 1.5rem; }
        input, textarea { width: 100%; padding: .8rem; background: var(--surface-light); border: 1px solid var(--border); border-radius: 6px; font-family: inherit; }
        textarea { min-height: 120px; font-family: 'Space Mono', monospace; }
        .btn { background: var(--accent); color: #fff; border: none; padding: .9rem 2rem; border-radius: 8px; font-weight: 600; cursor: pointer; width: 100%; margin-top: .75rem; }
        .btn:hover { background: var(--accent-dark); }
        table { width: 100%; border-collapse: collapse; font-family: 'Space Mono', monospace; font-size: .9rem; margin-top: 2rem;}
        th, td { padding: .75rem; border-bottom: 1px solid var(--border); text-align: left; }
        th { background: var(--surface-light); color: var(--accent); font-size: .75rem; }
        .calculator-display { background: var(--surface-light); border-radius: 8px; padding: 1.5rem; border: 1px solid var(--border); margin-top: 2rem; }
        .display-row { display: flex; justify-content: space-between; padding: .5rem 0; }
        .total-row { border-top: 2px solid var(--accent); font-size: 1.5rem; font-weight: 700; padding-top: 1rem; }
        .add-row { display: flex; gap: .5rem; margin-top: 1rem; }
        .add-btn { background: var(--success); color: white; border: none; padding: 0 1.5rem; border-radius: 6px; cursor: pointer; }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>Recipe Cost Calculator</h1>
        <p style="color:var(--text-dim)">Sheet Connected: FrenchHalwai</p>
    </header>

    <div class="calculator-card">
        <div class="section-label">Recipe Identity</div>
        <div class="recipe-meta">
            <input id="recipeName" placeholder="Recipe name">
            <input id="itemsPerBatch" type="number" value="1" min="1" oninput="calculateTotal()">
        </div>

        <div class="section-label">Paste Ingredients</div>
        <textarea id="recipeInput" placeholder="Example: 200 g sugar"></textarea>
        <button class="btn" onclick="extractIngredients()">Extract & Analyze</button>

        <table id="ingTable">
            <thead>
                <tr>
                    <th>Ingredient</th><th>Qty</th><th>Unit</th><th>Base</th><th>Price</th><th>Cost</th><th></th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>

        <div class="add-row">
            <input id="newIng" placeholder="Name">
            <input id="newQty" placeholder="Qty">
            <input id="newPrice" placeholder="Price">
            <button class="add-btn" onclick="addManual()">+</button>
        </div>

        <div class="calculator-display">
            <div class="display-row"><span>Total Batch Cost</span><span id="totalCost">₹0</span></div>
            <div class="display-row total-row"><span>Cost per Item</span><span id="perItem">₹0</span></div>
        </div>

        <button class="btn" style="background:#5d7a61; margin-top: 2rem;" onclick="exportToCSV()">Download CSV</button>
    </div>
</div>

<script>
    const MASTER_URL = "https://script.google.com/macros/s/AKfycbwuI-57C7vHJ_dCvJAcUsCKCdrSUtkIXhlJfas_AQfBlMnMfdusayP2M9A_KWRNzcOsRg/exec";
    let MASTER = {};
    let ingredients = [];
    const units = { g:1, kg:1000, ml:1, l:1000, tsp:5, tbsp:15, cup:240, unit:1 };

    // Fetch Master Data
    fetch(MASTER_URL)
        .then(r => r.json())
        .then(d => { MASTER = d; console.log("Data Loaded"); })
        .catch(e => console.error("Sheet Sync Failed"));

    function calculateCost(q, u, b, p) {
        const qty = parseFloat(q) || 0;
        const base = parseFloat(b) || 1;
        const price = parseFloat(p) || 0;
        const mult = units[u.toLowerCase()] || 1;
        return (qty * mult / base) * price;
    }

    function extractIngredients() {
        const input = document.getElementById('recipeInput').value;
        const lines = input.split('\n');
        ingredients = [];

        lines.forEach((line, index) => {
            if (!line.trim()) return;
            // Matches: "200 g sugar" or "200g sugar" or "1 unit egg"
            const match = line.match(/^([\d.\/½¼¾]+)\s*([a-zA-Z]*)\s*(.+)/);
            
            if (match) {
                const name = match[3].trim();
                const key = name.toLowerCase();
                const sheetData = MASTER[key];

                ingredients.push({
                    id: Date.now() + index,
                    name: name,
                    qty: match[1],
                    unit: match[2] || 'g',
                    bQty: sheetData ? sheetData.baseQty : 1000,
                    price: sheetData ? sheetData.price : 0,
                    locked: !!sheetData
                });
            }
        });
        render();
    }

    function render() {
        const body = document.getElementById('tableBody');
        body.innerHTML = ingredients.map(i => {
            const cost = calculateCost(i.qty, i.unit, i.bQty, i.price);
            return `<tr>
                <td><b>${i.name}</b></td>
                <td><input value="${i.qty}" onchange="upd(${i.id},'qty',this.value)"></td>
                <td><input value="${i.unit}" onchange="upd(${i.id},'unit',this.value)"></td>
                <td><input value="${i.bQty}" onchange="upd(${i.id},'bQty',this.value)"></td>
                <td><input type="number" value="${i.price}" ${i.locked ? 'disabled style="background:#eee"' : ''} onchange="upd(${i.id},'price',this.value)"></td>
                <td>₹${cost.toFixed(2)}</td>
                <td><button onclick="del(${i.id})" style="cursor:pointer; border:none; background:none; color:red;">✕</button></td>
            </tr>`;
        }).join('');
        calculateTotal();
    }

    function upd(id, field, val) {
        const item = ingredients.find(x => x.id === id);
        if (item) item[field] = val;
        render();
    }

    function del(id) {
        ingredients = ingredients.filter(x => x.id !== id);
        render();
    }

    function addManual() {
        const n = document.getElementById('newIng').value;
        if (!n) return;
        ingredients.push({
            id: Date.now(),
            name: n,
            qty: document.getElementById('newQty').value || 1,
            unit: 'g',
            bQty: 1000,
            price: document.getElementById('newPrice').value || 0,
            locked: false
        });
        render();
        document.getElementById('newIng').value = '';
        document.getElementById('newQty').value = '';
        document.getElementById('newPrice').value = '';
    }

    function calculateTotal() {
        const batch = parseFloat(document.getElementById('itemsPerBatch').value) || 1;
        const total = ingredients.reduce((sum, i) => sum + calculateCost(i.qty, i.unit, i.bQty, i.price), 0);
        document.getElementById('totalCost').innerText = `₹${total.toFixed(2)}`;
        document.getElementById('perItem').innerText = `₹${(total / batch).toFixed(2)}`;
    }

    function exportToCSV() {
        let csv = "Ingredient,Qty,Unit,Cost\n";
        ingredients.forEach(i => {
            const c = calculateCost(i.qty, i.unit, i.bQty, i.price);
            csv += `${i.name},${i.qty},${i.unit},${c.toFixed(2)}\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.setAttribute('href', url);
        a.setAttribute('download', 'costing.csv');
        a.click();
    }
</script>
</body>
</html>
