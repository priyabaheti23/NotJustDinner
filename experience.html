<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Recipe Costing</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=Space+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #F8F9FA; --card: #FFFFFF; --accent: #2D3436; 
            --text: #2D3436; --dim: #636E72; --border: #DFE6E9;
            --success: #00B894; --error: #D63031;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Outfit', sans-serif; background: var(--bg); color: var(--text); padding: 40px 20px; }
        .container { max-width: 900px; margin: 0 auto; }
        
        header { margin-bottom: 30px; text-align: center; }
        .card { background: var(--card); padding: 30px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        
        .grid { display: grid; grid-template-columns: 2fr 1fr; gap: 15px; margin-bottom: 20px; }
        label { display: block; font-size: 0.8rem; font-weight: 600; color: var(--dim); margin-bottom: 5px; text-transform: uppercase; }
        
        input, textarea { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-family: inherit; font-size: 1rem; }
        textarea { min-height: 120px; font-family: 'Space Mono', monospace; font-size: 0.9rem; }

        .btn { background: var(--accent); color: white; border: none; padding: 14px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; width: 100%; transition: 0.2s; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-save { background: var(--success); margin-top: 20px; }

        table { width: 100%; border-collapse: collapse; margin-top: 25px; font-size: 0.9rem; }
        th { text-align: left; padding: 12px; border-bottom: 2px solid var(--border); color: var(--dim); }
        td { padding: 12px; border-bottom: 1px solid var(--border); }
        
        .summary-box { background: var(--accent); color: white; padding: 25px; border-radius: 8px; margin-top: 25px; display: flex; justify-content: space-between; align-items: center; }
        .summary-val { font-size: 2rem; font-weight: 700; }
        .status { font-size: 0.8rem; margin-top: 10px; display: block; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Recipe Costing</h1>
        <span id="syncStatus" class="status">Connecting to Master...</span>
    </header>

    <div class="card">
        <div class="grid">
            <div>
                <label>Recipe Name</label>
                <input type="text" id="recipeName" placeholder="e.g., French Halwai">
            </div>
            <div>
                <label>Batch Yield (Items)</label>
                <input type="number" id="batchYield" value="1" min="1" oninput="calculate()">
            </div>
        </div>

        <label>Paste Ingredients (Qty Unit Name)</label>
        <textarea id="rawInput" placeholder="200 g Sugar&#10;100 ml Milk"></textarea>
        <button class="btn" style="margin-top:10px" onclick="analyze()">Analyze Ingredients</button>

        <table id="resultTable">
            <thead>
                <tr>
                    <th>Ingredient</th><th>Qty</th><th>Unit</th><th>Cost</th><th></th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>

        <div class="summary-box">
            <div>
                <p style="opacity:0.8">Total Batch Cost</p>
                <div class="summary-val" id="totalDisplay">₹0.00</div>
            </div>
            <div style="text-align: right">
                <p style="opacity:0.8">Cost Per Item</p>
                <div class="summary-val" id="perItemDisplay" style="color: #00B894">₹0.00</div>
            </div>
        </div>

        <button id="saveBtn" class="btn btn-save" onclick="logToSheet()">Save to Google Sheet</button>
    </div>
</div>

<script>
    // PASTE YOUR GOOGLE APPS SCRIPT WEB APP URL HERE
    const APP_URL = "https://script.google.com/macros/s/AKfycbwuI-57C7vHJ_dCvJAcUsCKCdrSUtkIXhlJfas_AQfBlMnMfdusayP2M9A_KWRNzcOsRg/exec";

    let masterPrices = [];
    let activeIngredients = [];
    const units = { g: 1, kg: 1000, ml: 1, l: 1000, tsp: 5, tbsp: 15, cup: 240, unit: 1 };

    // Initial load of prices
    window.onload = () => {
        fetch(`${APP_URL}?action=getPrices`)
            .then(res => res.json())
            .then(data => {
                masterPrices = data;
                document.getElementById('syncStatus').innerText = "✓ Synced with Master Sheet";
                document.getElementById('syncStatus').style.color = "var(--success)";
            })
            .catch(err => {
                document.getElementById('syncStatus').innerText = "✕ Sync Failed. Check URL.";
                document.getElementById('syncStatus').style.color = "var(--error)";
            });
    };

    function analyze() {
        const lines = document.getElementById('rawInput').value.split('\n');
        activeIngredients = [];

        lines.forEach(line => {
            if (!line.trim()) return;
            // Regex to handle "200 g sugar" or "200g sugar"
            const match = line.match(/^([\d.\/]+)\s*([a-zA-Z]*)\s+(.+)/);
            
            if (match) {
                const qty = evalFraction(match[1]);
                const unit = match[2].toLowerCase() || 'unit';
                const name = match[3].trim();
                
                // Find matching item in Master List (Case Insensitive)
                const priceInfo = masterPrices.find(p => 
                    p.ingredient.toString().toLowerCase().trim() === name.toLowerCase()
                );

                activeIngredients.push({
                    name,
                    qty,
                    unit,
                    baseQty: priceInfo ? priceInfo.base_qty : 1000,
                    price: priceInfo ? priceInfo.price : 0
                });
            }
        });
        render();
    }

    function evalFraction(str) {
        if (!str.includes('/')) return parseFloat(str);
        const parts = str.split('/');
        return parseFloat(parts[0]) / parseFloat(parts[1]);
    }

    function calculate() {
        let total = 0;
        activeIngredients.forEach(ing => {
            const mult = units[ing.unit] || 1;
            ing.lineCost = (ing.qty * mult / ing.baseQty) * ing.price;
            total += ing.lineCost;
        });

        const batch = parseFloat(document.getElementById('batchYield').value) || 1;
        document.getElementById('totalDisplay').innerText = `₹${total.toFixed(2)}`;
        document.getElementById('perItemDisplay').innerText = `₹${(total / batch).toFixed(2)}`;
        return total;
    }

    function render() {
        const body = document.getElementById('tableBody');
        body.innerHTML = activeIngredients.map((ing, i) => `
            <tr>
                <td><strong>${ing.name}</strong></td>
                <td>${ing.qty}</td>
                <td>${ing.unit}</td>
                <td>₹${((ing.qty * (units[ing.unit]||1) / ing.baseQty) * ing.price).toFixed(2)}</td>
                <td><button onclick="remove(${i})" style="background:none; border:none; color:red; cursor:pointer">✕</button></td>
            </tr>
        `).join('');
        calculate();
    }

    function remove(index) {
        activeIngredients.splice(index, 1);
        render();
    }

    function logToSheet() {
        const btn = document.getElementById('saveBtn');
        const name = document.getElementById('recipeName').value;
        const total = calculate();
        const batch = document.getElementById('batchYield').value;

        if (!name) return alert("Enter recipe name");

        btn.innerText = "Logging...";
        btn.disabled = true;

        const summary = activeIngredients.map(i => `${i.name} (${i.qty}${i.unit})`).join(", ");

        const params = new URLSearchParams({
            action: "logRecipe",
            recipeName: name,
            date: new Date().toLocaleDateString(),
            batchYield: batch,
            totalCost: total.toFixed(2),
            costPerItem: (total / batch).toFixed(2),
            ingredientCount: activeIngredients.length,
            summary: summary
        });

        fetch(`${APP_URL}?${params.toString()}`, { method: 'POST' })
            .then(() => {
                alert("Recipe saved successfully!");
                btn.innerText = "Save to Google Sheet";
                btn.disabled = false;
            })
            .catch(() => {
                alert("Error saving.");
                btn.disabled = false;
            });
    }
</script>

</body>
</html>
